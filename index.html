<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Planilha Online – Ganhos & Gastos</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #1f2937;
      --text: #e5e7eb;
      --text-dim: #9ca3af;
      --primary: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
      --accent: #38bdf8;
      --radius: 16px;
      --shadow: 0 10px 25px rgba(0, 0, 0, .35)
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji';
      background: linear-gradient(180deg, #0b1220, #0f172a 40% 100%);
      color: var(--text)
    }

    .container {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px
    }

    .card {
      background: var(--panel);
      border: 1px solid #1f2937;
      border-radius: var(--radius);
      box-shadow: var(--shadow)
    }

    .card.pad {
      padding: 16px
    }

    .row {
      display: grid;
      gap: 12px
    }

    @media (min-width:768px) {
      .row.cols-2 {
        grid-template-columns: 1fr 1fr
      }
    }

    @media (min-width:1024px) {
      .row.cols-3 {
        grid-template-columns: 1fr 1fr 1fr
      }
    }

    .btn {
      appearance: none;
      border: none;
      border-radius: 12px;
      padding: 14px 16px;
      font-weight: 700;
      cursor: pointer;
      background: var(--muted);
      color: var(--text);
      transition: transform .04s ease, opacity .2s ease, filter .2s ease;
      font-size: 15px
    }

    .btn:hover {
      filter: brightness(1.1)
    }

    .btn:active {
      transform: translateY(1px)
    }

    .btn.primary {
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: #062a12
    }

    .btn.warn {
      background: #1f2937;
      border: 1px solid var(--warning)
    }

    .btn.danger {
      background: #1f2937;
      border: 1px solid var(--danger)
    }

    .btn.ghost {
      background: transparent;
      border: 1px solid #334155
    }

    .input,
    select {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      background: #0b1220;
      color: var(--text);
      border: 1px solid #233047;
      outline: none;
      font-size: 16px
    }

    .input:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(56, 189, 248, .15)
    }

    label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--text-dim);
      display: block;
      margin: 10px 0 6px
    }

    .badge {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 999px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px
    }

    .badge.income {
      background: rgba(34, 197, 94, .15);
      color: #86efac;
      border: 1px solid rgba(34, 197, 94, .3)
    }

    .badge.expense {
      background: rgba(239, 68, 68, .15);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, .3)
    }

    header.appbar {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(8px);
      background: rgba(2, 6, 23, .65);
      border-bottom: 1px solid #1f2937
    }

    .appbar-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 16px
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800
    }

    .brand .logo {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: linear-gradient(135deg, #06b6d4, #22d3ee 60%, #0ea5e9);
      box-shadow: inset 0 0 15px rgba(255, 255, 255, .15), 0 8px 20px rgba(14, 165, 233, .25)
    }

    .stat {
      padding: 16px;
      border-radius: 12px;
      background: #0b1220;
      border: 1px solid #1f2937
    }

    .stat h3 {
      margin: 0 0 6px;
      font-size: 12px;
      color: var(--text-dim);
      letter-spacing: .08em;
      text-transform: uppercase
    }

    .stat p {
      margin: 0;
      font-size: 22px;
      font-weight: 800
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    thead th {
      position: sticky;
      top: 0;
      background: #0b1220;
      color: var(--text-dim);
      text-align: left;
      padding: 12px;
      font-size: 12px;
      letter-spacing: .08em;
      text-transform: uppercase;
      border-bottom: 1px solid #233047
    }

    tbody td {
      padding: 12px;
      border-bottom: 1px solid #1f2937;
      vertical-align: middle
    }

    tbody tr:hover {
      background: rgba(56, 189, 248, .05)
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .footer {
      color: var(--text-dim);
      font-size: 12px;
      text-align: center;
      margin: 24px 0 12px
    }

    .login-wrap {
      display: grid;
      min-height: 100dvh;
      place-items: center;
      padding: 24px
    }

    .login {
      width: 100%;
      max-width: 440px
    }

    .login h1 {
      margin: 0 0 14px
    }

    .sticky-bottom {
      position: sticky;
      bottom: 0;
      padding-top: 12px;
      background: linear-gradient(180deg, transparent, rgba(2, 6, 23, .8))
    }

    .toolbar-mobile {
      position: sticky;
      bottom: 0;
      display: flex;
      gap: 8px;
      background: rgba(2, 6, 23, .7);
      backdrop-filter: blur(6px);
      padding: 10px;
      border-top: 1px solid #1f2937;
      border-radius: 12px
    }

    .toolbar-mobile .btn {
      flex: 1
    }

    .table-scroll {
      overflow: auto;
      max-height: 60vh;
      border: 1px solid #1f2937;
      border-radius: 12px;
      -webkit-overflow-scrolling: touch
    }

    @media (max-width:540px) {
      .actions .btn {
        padding: 10px 12px;
        font-size: 14px
      }

      .stat p {
        font-size: 20px
      }
    }

    /* Garantir estado inicial */
    #app {
      display: none !important
    }

    #login {
      display: block !important
    }
  </style>
</head>

<body>
  <!-- LOGIN -->
  <section id="login-view" class="login-wrap">
    <div class="card pad login">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
        <div class="logo"
          style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#16a34a,#22c55e 60%,#86efac);">
        </div>
        <h1>Entrar na Planilha</h1>
      </div>
      <p style="margin-top:-6px;color:var(--text-dim)">
        Use seu usuário e senha para acessar. <br>
        <small>Dica: <code>wandersson</code> / <code>2025</code> ou <code>gislaine</code> / <code>2025</code></small>
      </p>
      <form id="login-form">
        <label for="user">Usuário</label>
        <input class="input" id="user" autocomplete="username" placeholder="Usuario" required>
        <label for="pass">Senha</label>
        <input class="input" id="pass" type="password" autocomplete="current-password" placeholder="••••" required>
        <div style="display:flex;gap:8px;margin-top:14px;align-items:center;justify-content:space-between;">
          <button class="btn primary" type="submit">Entrar</button>
          <small id="login-msg" style="color:#fca5a5;visibility:hidden;">Usuário ou senha inválidos.</small>
        </div>
      </form>
    </div>
  </section>

  <!-- APP -->
  <section id="app" style="display:none;">
    <header class="appbar">
      <div class="appbar-inner container">
        <div class="brand">
          <div class="logo"></div>
          <span>Planilha de Ganhos & Gastos</span>
        </div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button id="btn-export" class="btn ghost" title="Exportar JSON">Exportar JSON</button>
          <button id="btn-pdf" class="btn ghost" title="Gerar PDF">Relatório PDF</button>
          <button id="btn-logout" class="btn danger">Sair</button>
        </div>
      </div>
    </header>

    <main class="container" style="display:grid; gap:16px;">
      <!-- Filtros -->
      <div class="card pad">
        <form id="filters" class="row cols-3" style="align-items:end;">
          <div>
            <label for="filter-month">Mês</label>
            <select id="filter-month"></select>
          </div>
          <div>
            <label for="filter-year">Ano</label>
            <select id="filter-year"></select>
          </div>
          <div style="display:flex; gap:8px;">
            <button type="submit" class="btn primary" style="flex:1;">Aplicar Filtro</button>
            <button id="btn-clear-filter" class="btn" type="button">Limpar</button>
          </div>
        </form>
      </div>

      <!-- Resumo -->
      <div class="row cols-3">
        <div class="stat">
          <h3>Ganhos (mês)</h3>
          <p id="sum-income">R$ 0,00</p>
        </div>
        <div class="stat">
          <h3>Gastos (mês)</h3>
          <p id="sum-expense">R$ 0,00</p>
        </div>
        <div class="stat">
          <h3>Saldo (mês)</h3>
          <p id="sum-balance">R$ 0,00</p>
        </div>
      </div>

      <!-- Form de lançamento -->
      <div class="card pad">
        <form id="form" class="row cols-3">
          <div>
            <label for="type">Tipo</label>
            <select id="type" required>
              <option value="income">Ganho</option>
              <option value="expense">Gasto</option>
            </select>
          </div>
          <div>
            <label for="date">Data</label>
            <input id="date" class="input" type="date" required>
          </div>
          <div>
            <label for="amount">Valor</label>
            <input id="amount" class="input" inputmode="decimal" placeholder="0,00" required>
          </div>
          <div>
            <label for="desc">Descrição</label>
            <input id="desc" class="input" placeholder="Ex.: Salário, Mercado, Uber" required>
          </div>
          <div>
            <label for="category">Categoria</label>
            <input id="category" class="input" list="cats" placeholder="Selecione ou digite">
            <datalist id="cats">
              <option>Alimentação</option>
              <option>Transporte</option>
              <option>Moradia</option>
              <option>Saúde</option>
              <option>Lazer</option>
              <option>Educação</option>
              <option>Salário</option>
              <option>Freelance</option>
              <option>Outros</option>
            </datalist>
          </div>
          <div class="sticky-bottom toolbar-mobile">
            <button id="btn-add" class="btn primary" type="submit">Adicionar</button>
            <button class="btn ghost" type="button" id="btn-import-ui">Importar</button>
            <input id="import-file" type="file" accept="application/json" style="display:none;">
          </div>
        </form>
      </div>

      <!-- Tabela -->
      <div class="card pad">
        <div
          style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:8px;flex-wrap:wrap;">
          <h2 style="margin:0;">Lançamentos</h2>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="btn-import" class="btn ghost" type="button" title="Importar JSON">Importar</button>
          </div>
        </div>
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Tipo</th>
                <th>Descrição</th>
                <th>Categoria</th>
                <th>Valor</th>
                <th style="width:150px;">Ações</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <p class="footer">Dados salvos no Firebase por usuário. Exporte para backup.</p>
    </main>
  </section>

  <!-- Firebase compat (garante funcionamento amplo em mobile e file://) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js">
    // Forçar estado inicial: sempre mostrar login ao carregar
    document.addEventListener('DOMContentLoaded', function () {
      try { if (typeof showLogin === 'function') { showLogin(); } } catch (_) { }
    });
  </script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- jsPDF + autoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <script>
    // ==== CONFIG FIREBASE (a sua) ====
    const firebaseConfig = {
      apiKey: "AIzaSyBoUUf8oBSL-5z7xEfPDPoMZcs10YYpyxc",
      authDomain: "planilha-financeira-1c4cc.firebaseapp.com",
      projectId: "planilha-financeira-1c4cc",
      storageBucket: "planilha-financeira-1c4cc.firebasestorage.app",
      messagingSenderId: "101170904419",
      appId: "1:101170904419:web:167e1451a082486eeb2756"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // (Opcional) Persistência offline
    if (db.enablePersistence) {
      db.enablePersistence().catch(() => { });
    }

    // ====== Estado / Utils ======
    const SESSION_KEY = 'wg_financas_session';
    const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const pad = (n) => String(n).padStart(2, '0');
    const brl = (n) => fmt.format(n || 0);
    function parseBRL(str) {
      if (!str) return NaN;
      const s = String(str).replace(/\./g, '').replace(',', '.').replace(/[^0-9.-]/g, '');
      return Number(s);
    }
    function escapeHtml(s) { return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;'); }

    let currentUser = null;
    let data = [];
    let unsubscribe = null;

    // ====== Login ======
    const allowed = { wandersson: '2025', gislaine: '2025' };
    const loginView = document.getElementById('login-view');
    const appView = document.getElementById('app');
    const loginForm = document.getElementById('login-form');
    const loginMsg = document.getElementById('login-msg');

    function showApp() {
      loginView.style.display = 'none';
      appView.style.display = 'block';
      populateMonthYearSelectors();
      applyFilter();
    }

    // sessão
    const previous = sessionStorage.getItem(SESSION_KEY);
    if (previous) {
      currentUser = previous;
      // attachRealtime only after login
    }

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const u = document.getElementById('user').value.trim().toLowerCase();
      const p = document.getElementById('pass').value.trim();
      if (allowed[u] && allowed[u] === p) {
        currentUser = u;
        sessionStorage.setItem(SESSION_KEY, u);
        // attachRealtime only after login
      } else {
        loginMsg.style.visibility = 'visible';
      }
    });

    document.getElementById('btn-logout').addEventListener('click', () => {
      sessionStorage.removeItem(SESSION_KEY);
      if (unsubscribe) unsubscribe();
      currentUser = null;
      location.reload();
    });

    // ====== Firestore: listener por usuário ======
    async function attachRealtime() {
      if (!currentUser) return;
      if (unsubscribe) unsubscribe();

      unsubscribe = db.collection('transacoes')
        .where('user', '==', currentUser)
        .onSnapshot((snap) => {
          const arr = [];
          snap.forEach(d => {
            const v = d.data();
            arr.push({ id: d.id, ...v });
          });
          data = arr.sort((a, b) => String(a.date).localeCompare(String(b.date)));
          populateMonthYearSelectors();
          applyFilter();
        }, (err) => {
          console.error('Firestore listener error:', err);
          alert('Erro ao conectar ao banco de dados.');
        });
    }

    // ====== Filtros ======
    const monthSel = document.getElementById('filter-month');
    const yearSel = document.getElementById('filter-year');

    function populateMonthYearSelectors() {
      const months = [
        '01 - Janeiro', '02 - Fevereiro', '03 - Março', '04 - Abril', '05 - Maio', '06 - Junho',
        '07 - Julho', '08 - Agosto', '09 - Setembro', '10 - Outubro', '11 - Novembro', '12 - Dezembro'
      ];
      monthSel.innerHTML = months.map((m, i) => `<option value="${i + 1}">${m}</option>`).join('');

      const yearsInData = new Set(data.map(x => Number(String(x.date).slice(0, 4))).filter(Boolean));
      const nowY = new Date().getFullYear(); yearsInData.add(nowY);
      const years = Array.from(yearsInData).sort((a, b) => a - b);
      yearSel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');

      const now = new Date();
      if (!monthSel.value) monthSel.value = String(now.getMonth() + 1);
      if (!yearSel.value) yearSel.value = String(now.getFullYear());
    }

    document.getElementById('filters').addEventListener('submit', (e) => {
      e.preventDefault(); applyFilter();
    });
    document.getElementById('btn-clear-filter').addEventListener('click', () => {
      const now = new Date();
      monthSel.value = String(now.getMonth() + 1);
      yearSel.value = String(now.getFullYear());
      applyFilter();
    });

    // ====== Form Lançamento ======
    const form = document.getElementById('form');
    const tbody = document.getElementById('tbody');
    const addBtn = document.getElementById('btn-add');

    document.getElementById('date').value = new Date().toISOString().slice(0, 10);
    const amountInput = document.getElementById('amount');
    amountInput.addEventListener('blur', () => {
      const n = parseBRL(amountInput.value);
      if (!isNaN(n)) amountInput.value = brl(n);
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) { alert('Você precisa estar logado.'); return; }

      const type = document.getElementById('type').value;
      const date = document.getElementById('date').value;
      const amountRaw = document.getElementById('amount').value;
      const desc = document.getElementById('desc').value.trim();
      const category = document.getElementById('category').value.trim();

      if (!date) { alert('Informe a data'); return; }
      const amount = parseBRL(amountRaw);
      if (isNaN(amount)) { alert('Valor inválido'); return; }

      // feedback para evitar "não clicou"
      addBtn.disabled = true;
      addBtn.textContent = 'Salvando...';

      try {
        await db.collection('transacoes').add({
          user: currentUser, type, date, amount, desc, category, createdAt: Date.now()
        });
        form.reset();
        document.getElementById('type').value = type;
        document.getElementById('date').value = new Date().toISOString().slice(0, 10);
      } catch (err) {
        console.error(err);
        alert('Falha ao salvar no Firebase. Verifique as Regras do Firestore.');
      } finally {
        addBtn.disabled = false;
        addBtn.textContent = 'Adicionar';
      }
    });

    // ====== Render + Filtro ======
    function applyFilter() {
      const m = Number(monthSel.value);
      const y = Number(yearSel.value);
      const filtered = data.filter(x => {
        const d = new Date(String(x.date) + 'T00:00:00');
        return (d.getMonth() + 1) === m && d.getFullYear() === y;
      });
      renderTable(filtered);
      renderSummary(filtered);
    }

    function renderSummary(list) {
      const incomes = list.filter(x => x.type === 'income').reduce((s, x) => s + x.amount, 0);
      const expenses = list.filter(x => x.type === 'expense').reduce((s, x) => s + x.amount, 0);
      const balance = incomes - expenses;
      document.getElementById('sum-income').textContent = brl(incomes);
      document.getElementById('sum-expense').textContent = brl(expenses);
      const balEl = document.getElementById('sum-balance');
      balEl.textContent = brl(balance);
      balEl.style.color = balance >= 0 ? '#86efac' : '#fca5a5';
    }

    function renderTable(list) {
      if (!list.length) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--text-dim);padding:20px;">Nenhum lançamento neste mês.</td></tr>`;
        return;
      }
      tbody.innerHTML = list.map(row => {
        const d = new Date(String(row.date) + 'T00:00:00');
        const date = `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()}`;
        const badge = row.type === 'income' ? '<span class="badge income">Ganho</span>' : '<span class="badge expense">Gasto</span>';
        return `
          <tr data-id="${row.id}">
            <td>${date}</td>
            <td>${badge}</td>
            <td>${escapeHtml(row.desc || '')}</td>
            <td>${escapeHtml(row.category || '')}</td>
            <td style="font-weight:800;">${brl(row.amount)}</td>
            <td>
              <div class="actions">
                <button class="btn ghost" data-action="edit">Editar</button>
                <button class="btn warn" data-action="dup">Duplicar</button>
                <button class="btn danger" data-action="del">Excluir</button>
              </div>
            </td>
          </tr>`;
      }).join('');
    }

    // Ações de linha
    tbody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button'); if (!btn) return;
      const tr = e.target.closest('tr'); const id = tr?.dataset?.id;
      const item = data.find(x => x.id === id); if (!item) return;

      if (btn.dataset.action === 'del') {
        if (confirm('Excluir lançamento?')) {
          try { await db.collection('transacoes').doc(id).delete(); }
          catch (err) { console.error(err); alert('Erro ao excluir.'); }
        }
      }
      if (btn.dataset.action === 'dup') {
        try {
          await db.collection('transacoes').add({
            user: currentUser, type: item.type, date: item.date, amount: item.amount,
            desc: item.desc, category: item.category, createdAt: Date.now()
          });
        } catch (err) { console.error(err); alert('Erro ao duplicar.'); }
      }
      if (btn.dataset.action === 'edit') {
        const novadata = prompt('Data (AAAA-MM-DD):', item.date) || item.date;
        const novotipo = prompt('Tipo (income/expense):', item.type) || item.type;
        const novadesc = prompt('Descrição:', item.desc ?? '') ?? item.desc;
        const novacat = prompt('Categoria:', item.category ?? '') ?? item.category;
        const novoval = prompt('Valor (use vírgula para centavos):', String(item.amount).replace('.', ',')) ?? String(item.amount);
        const num = parseBRL(novoval);
        if (isNaN(num)) return alert('Valor inválido');
        try {
          await db.collection('transacoes').doc(id).update({ date: novadata, type: novotipo, desc: novadesc, category: novacat, amount: num });
        } catch (err) { console.error(err); alert('Erro ao editar.'); }
      }
    });

    // ====== Import/Export JSON ======
    document.getElementById('btn-export').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `planilha-${currentUser || 'usuario'}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });
    const importUIBtn = document.getElementById('btn-import-ui');
    const importBtn = document.getElementById('btn-import');
    const importFile = document.getElementById('import-file');
    importUIBtn.addEventListener('click', () => importFile.click());
    importBtn.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', async () => {
      const file = importFile.files?.[0]; if (!file) return;
      try {
        const text = await file.text();
        const json = JSON.parse(text);
        if (!Array.isArray(json)) throw new Error('Arquivo inválido');
        const batch = json.filter(x => x && typeof x === 'object' && x.date && x.type && typeof x.amount === 'number');
        for (const x of batch) {
          await db.collection('transacoes').add({
            user: currentUser, type: x.type, date: x.date, amount: x.amount, desc: x.desc || '', category: x.category || '', createdAt: Date.now()
          });
        }
        importFile.value = '';
        alert('Importado com sucesso!');
      } catch (err) {
        alert('Falha ao importar: ' + err.message);
      }
    });

    // ====== PDF (Resumo + Tabela Completa) ======
    document.getElementById('btn-pdf').addEventListener('click', () => {
      const m = Number(document.getElementById('filter-month').value);
      const y = Number(document.getElementById('filter-year').value);
      const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
      const header = `Relatório Financeiro - ${monthNames[m - 1]}/${y} • Usuário: ${currentUser}`;

      const filtered = data.filter(x => {
        const d = new Date(String(x.date) + 'T00:00:00');
        return (d.getMonth() + 1) === m && d.getFullYear() === y;
      });

      const incomes = filtered.filter(x => x.type === 'income').reduce((s, x) => s + x.amount, 0);
      const expenses = filtered.filter(x => x.type === 'expense').reduce((s, x) => s + x.amount, 0);
      const balance = incomes - expenses;

      const { jsPDF } = window.jspdf;
      const docPDF = new jsPDF({ unit: 'pt', format: 'a4' });

      docPDF.setFontSize(14);
      docPDF.text(header, 40, 40);

      docPDF.setFontSize(11);
      docPDF.text(`Ganhos: ${brl(incomes)}   Gastos: ${brl(expenses)}   Saldo: ${brl(balance)}`, 40, 64);

      const rows = filtered.map(x => {
        const d = new Date(String(x.date) + 'T00:00:00');
        const dia = `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()}`;
        return [dia, x.type === 'income' ? 'Ganho' : 'Gasto', x.desc || '', x.category || '', brl(x.amount)];
      });

      docPDF.autoTable({
        head: [['Data', 'Tipo', 'Descrição', 'Categoria', 'Valor']],
        body: rows,
        startY: 80,
        styles: { fontSize: 10, cellPadding: 6 },
        headStyles: { fillColor: [22, 163, 74] }
      });

      docPDF.save(`relatorio-${currentUser}-${y}-${String(m).padStart(2, '0')}.pdf`);
    });

    // ====== UX extra ======
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
        const inputs = Array.from(document.getElementById('form').querySelectorAll('input, select'));
        const i = inputs.indexOf(e.target);
        if (i > -1 && i < inputs.length - 1) { e.preventDefault(); inputs[i + 1].focus(); }
      }
    });
  </script>
</body>

</html>
